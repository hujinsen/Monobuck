<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‹ç« ç³»ç»Ÿé›†æˆç¤ºä¾‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .demo-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .demo-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .demo-btn {
            padding: 10px 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .demo-btn:hover {
            background: #3730a3;
        }
        
        .demo-btn.secondary {
            background: #6b7280;
        }
        
        .demo-btn.success {
            background: #10b981;
        }
        
        .stats-display {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .stat-label {
            color: #6b7280;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† å‹‹ç« ç³»ç»Ÿé›†æˆç¤ºä¾‹</h1>
            <p>æ¼”ç¤ºå¦‚ä½•åœ¨é¡¹ç›®ä¸­é›†æˆå’Œä½¿ç”¨å‹‹ç« ç³»ç»Ÿ</p>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="demo-section">
            <h2>ğŸ® æ“ä½œæ§åˆ¶</h2>
            <div class="demo-controls">
                <button class="demo-btn" onclick="simulateUsage(100, 5, true)">åˆå…¥æ±Ÿæ¹–</button>
                <button class="demo-btn" onclick="simulateUsage(500, 15, false)">æ—¥å¸¸ä¿®è¡Œ</button>
                <button class="demo-btn" onclick="simulateUsage(1000, 30, true)">å¼ºåŠ›å†²åˆº</button>
                <button class="demo-btn" onclick="simulateNightUsage()">å¤œåŠé’Ÿå£°</button>
                <button class="demo-btn" onclick="simulateStreak()">è¿ç»­7å¤©</button>
                <button class="demo-btn secondary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="demo-btn secondary" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                <button class="demo-btn success" onclick="shareRandomBadge()">åˆ†äº«å‹‹ç« </button>
            </div>
            
            <!-- ç»Ÿè®¡æ˜¾ç¤º -->
            <div class="stats-display">
                <h3>ğŸ“Š å½“å‰ç»Ÿè®¡</h3>
                <div class="stats-grid" id="statsDisplay">
                    <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <div class="layout">
            <!-- å‹‹ç« ç½‘æ ¼ -->
            <div class="demo-section">
                <h2>ğŸ† å‹‹ç« å±•ç¤º</h2>
                <div id="badgeGrid">
                    <!-- å‹‹ç« ç½‘æ ¼å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="demo-section">
                <h2>ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡</h2>
                <div id="statsPanel">
                    <!-- ç»Ÿè®¡é¢æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥ -->
    <div id="notification" style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 1000;
        max-width: 300px;
        display: none;
    ">
        <div id="notificationContent"></div>
    </div>
    
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script type="module">
        import { 
            EnhancedAchievementEngine, 
            EnhancedLocalStorageStore,
            CREATIVE_DEFINITIONS,
            BADGE_STORIES
        } from './enhanced-engine.js';
        
        import { 
            AchievementGrid, 
            AchievementStatsPanel 
        } from './ui-components.js';
        
        // å…¨å±€å˜é‡
        let engine;
        let grid;
        let statsPanel;
        
        // åˆå§‹åŒ–
        async function init() {
            // åˆ›å»ºå¼•æ“
            engine = new EnhancedAchievementEngine({
                definitions: CREATIVE_DEFINITIONS,
                store: new EnhancedLocalStorageStore('demo'),
                stories: BADGE_STORIES,
                enableAnalytics: true
            });
            
            // åˆ›å»ºUIç»„ä»¶
            grid = new AchievementGrid('#badgeGrid', {
                showFilters: true,
                showSearch: true,
                badgeOptions: {
                    stories: BADGE_STORIES
                },
                onShare: handleShare,
                onClick: handleBadgeClick
            });
            
            statsPanel = new AchievementStatsPanel('#statsPanel', {
                showRarityDistribution: true,
                showThemeProgress: true,
                showMiniWall: false
            });
            
            // è®¾ç½®æ•°æ®
            grid.setDefinitions(CREATIVE_DEFINITIONS);
            
            // åŠ è½½åˆå§‹æ•°æ®
            await updateDisplay();
            
            console.log('ğŸ‰ å‹‹ç« ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ›´æ–°æ˜¾ç¤º
        async function updateDisplay() {
            const unlockedBadges = await engine.store.getUnlocked();
            const stats = await engine.store.getUserStats();
            const detailedStats = await engine.getDetailedStats();
            
            // æ›´æ–°ç½‘æ ¼
            grid.setUnlockedBadges(unlockedBadges);
            
            // æ›´æ–°ç»Ÿè®¡é¢æ¿
            statsPanel.setStats(detailedStats);
            
            // æ›´æ–°åŸºç¡€ç»Ÿè®¡æ˜¾ç¤º
            updateStatsDisplay(stats, unlockedBadges.length);
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay(stats, unlockedCount) {
            const display = document.getElementById('statsDisplay');
            display.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${unlockedCount}</div>
                    <div class="stat-label">å·²è§£é”å‹‹ç« </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalUsage || 0}</div>
                    <div class="stat-label">ä½¿ç”¨æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalWords || 0}</div>
                    <div class="stat-label">æ€»å­—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.currentStreak || 0}</div>
                    <div class="stat-label">è¿ç»­å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalDuration || 0}</div>
                    <div class="stat-label">æ€»æ—¶é•¿(åˆ†é’Ÿ)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round((unlockedCount / CREATIVE_DEFINITIONS.length) * 100)}%</div>
                    <div class="stat-label">å®Œæˆåº¦</div>
                </div>
            `;
        }
        
        // æ¨¡æ‹Ÿä½¿ç”¨
        async function simulateUsage(words, duration, perfect) {
            try {
                const result = await engine.onTranscriptionComplete(words, duration, { perfect });
                
                if (result.unlocked.length > 0) {
                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification(`ğŸ‰ è§£é”äº† ${result.unlocked.length} ä¸ªæ–°å‹‹ç« ï¼`);
                    
                    // æ·»åŠ åˆ°ç½‘æ ¼ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                    result.unlocked.forEach(badge => {
                        grid.addUnlockedBadge(badge);
                    });
                } else {
                    showNotification('ğŸ“ˆ ç»Ÿè®¡å·²æ›´æ–°');
                }
                
                await updateDisplay();
                
            } catch (error) {
                console.error('æ¨¡æ‹Ÿä½¿ç”¨å¤±è´¥:', error);
                showNotification('âŒ æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // æ¨¡æ‹Ÿå¤œé—´ä½¿ç”¨
        async function simulateNightUsage() {
            const originalDate = window.Date;
            
            // æ¨¡æ‹Ÿå‡Œæ™¨2ç‚¹
            const mockDate = new Date();
            mockDate.setHours(2, 0, 0, 0);
            
            window.Date = function(...args) {
                if (args.length === 0) return mockDate;
                return new originalDate(...args);
            };
            window.Date.prototype = originalDate.prototype;
            
            await simulateUsage(200, 8, false);
            
            // æ¢å¤Date
            window.Date = originalDate;
        }
        
        // æ¨¡æ‹Ÿè¿ç»­ä½¿ç”¨
        async function simulateStreak() {
            showNotification('ğŸ”„ æ­£åœ¨æ¨¡æ‹Ÿ7å¤©è¿ç»­ä½¿ç”¨...');
            
            for (let i = 0; i < 7; i++) {
                const mockDate = new Date();
                mockDate.setDate(mockDate.getDate() + i);
                
                const originalDate = window.Date;
                window.Date = function(...args) {
                    if (args.length === 0) return mockDate;
                    return new originalDate(...args);
                };
                window.Date.prototype = originalDate.prototype;
                
                const result = await engine.onTranscriptionComplete(100 + i * 20, 5 + i, { perfect: i % 2 === 0 });
                
                window.Date = originalDate;
                
                if (result.unlocked.length > 0) {
                    result.unlocked.forEach(badge => {
                        grid.addUnlockedBadge(badge);
                    });
                }
                
                // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            await updateDisplay();
            showNotification('âœ… 7å¤©è¿ç»­ä½¿ç”¨æ¨¡æ‹Ÿå®Œæˆï¼');
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const exportResult = await engine.exportData('json');
                
                const blob = new Blob([exportResult.content], { type: exportResult.mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = exportResult.filename;
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification('ğŸ“„ æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('âŒ å¯¼å‡ºå¤±è´¥', 'error');
            }
        }
        
        // å¯¼å…¥æ•°æ®
        function importData() {
            const fileInput = document.getElementById('fileInput');
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    const result = await engine.importData(data);
                    
                    if (result.success) {
                        await updateDisplay();
                        showNotification(`âœ… å¯¼å…¥æˆåŠŸï¼æ¢å¤äº† ${result.imported.badges} ä¸ªå‹‹ç« `);
                    } else {
                        showNotification(`âŒ å¯¼å…¥å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showNotification('âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                fileInput.value = '';
            };
            
            fileInput.click();
        }
        
        // åˆ†äº«éšæœºå‹‹ç« 
        async function shareRandomBadge() {
            const unlockedBadges = await engine.store.getUnlocked();
            
            if (unlockedBadges.length === 0) {
                showNotification('âŒ è¿˜æ²¡æœ‰è§£é”ä»»ä½•å‹‹ç« ');
                return;
            }
            
            const randomBadge = unlockedBadges[Math.floor(Math.random() * unlockedBadges.length)];
            const shareData = await engine.generateShareData(randomBadge.id);
            
            if (shareData) {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                try {
                    await navigator.clipboard.writeText(shareData.shareText);
                    showNotification('ğŸ“‹ åˆ†äº«æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (error) {
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºåˆ†äº«æ–‡æœ¬
                    alert(shareData.shareText);
                }
            }
        }
        
        // å¤„ç†å‹‹ç« åˆ†äº«
        async function handleShare(badgeId) {
            const shareData = await engine.generateShareData(badgeId);
            
            if (shareData) {
                try {
                    await navigator.clipboard.writeText(shareData.shareText);
                    showNotification('ğŸ“‹ åˆ†äº«æ–‡æœ¬å·²å¤åˆ¶ï¼');
                } catch (error) {
                    alert(shareData.shareText);
                }
            }
        }
        
        // å¤„ç†å‹‹ç« ç‚¹å‡»
        function handleBadgeClick(badgeId) {
            console.log('ç‚¹å‡»å‹‹ç« :', badgeId);
            showNotification(`ğŸ¯ æŸ¥çœ‹å‹‹ç« : ${badgeId}`);
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            content.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'error' ? '#dc2626' : '#10b981';
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // æš´éœ²å…¨å±€å‡½æ•°
        window.simulateUsage = simulateUsage;
        window.simulateNightUsage = simulateNightUsage;
        window.simulateStreak = simulateStreak;
        window.exportData = exportData;
        window.importData = importData;
        window.shareRandomBadge = shareRandomBadge;
        
        // åˆå§‹åŒ–åº”ç”¨
        init().catch(console.error);
    </script>
</body>
</html>